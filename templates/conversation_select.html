<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <link rel="apple-touch-icon" href="/static/images/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#E07A5F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Choose Conversation - Your Hindi Tutor</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Eczar:wght@400;500;600;700;800&family=Poppins:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/mobile-design-system.css">
    <link rel="stylesheet" href="/static/css/conversation-select-modules.css">
    <script src="/static/js/mobile-navigation.js" defer></script>

    <style>
        /* History toggle button */
        .history-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--text-dark);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            flex-shrink: 0;
        }

        .history-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .hamburger-icon {
            font-size: 1.2rem;
        }

        .history-text {
            font-size: 0.9rem;
        }

        /* Sidebar overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* History sidebar */
        .history-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 85vw;
            height: 100vh;
            background: white;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .history-sidebar.active {
            transform: translateX(0);
        }

        /* Sidebar header */
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            background: var(--primary-green);
            color: white;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-sidebar-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .close-sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Sidebar content */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Loading state */
        .history-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            color: #6b7280;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* History list */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* History item */
        .history-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #f3f4f6;
            border-color: var(--primary-green);
            transform: translateY(-1px);
        }

        .history-item-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .history-item-icon {
            font-size: 1.2rem;
        }

        .history-item-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .history-item-date {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: auto;
        }

        .history-item-preview {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .history-item-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .history-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Empty state */
        .history-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #6b7280;
        }

        .history-empty p {
            margin: 0.5rem 0;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .history-sidebar {
                width: 280px;
            }

            .history-text {
                display: none;
            }

            .sidebar-content {
                padding: 0.75rem;
            }

            .history-item {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Bar with Profile Only -->
        <header class="mobile-top-bar">
            <!-- History button -->
            <button id="historyToggle" class="history-toggle-btn">
                <span class="hamburger-icon">‚ò∞</span>
                <span class="history-text">History</span>
            </button>

            <!-- Profile avatar will be inserted here by JavaScript -->
        </header>

        <!-- Conversation History Sidebar -->
        <div id="historySidebar" class="history-sidebar">
            <div class="sidebar-header">
                <h3>Recent Conversations</h3>
                <button id="closeSidebar" class="close-sidebar-btn">√ó</button>
            </div>
            <div class="sidebar-content">
                <div id="historyLoading" class="history-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading conversations...</p>
                </div>
                <div id="historyList" class="history-list"></div>
                <div id="historyEmpty" class="history-empty" style="display: none;">
                    <p>No recent conversations found.</p>
                    <p>Start a new conversation to see it here!</p>
                </div>
            </div>
        </div>

        <!-- Sidebar overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- First-time user spotlight overlay -->
        <div id="introSpotlightOverlay" class="intro-spotlight-overlay"></div>

        <!-- Kiki intro audio -->
        <audio id="kikiIntroAudio" preload="auto">
            <source src="/static/audio/kiki_intro.mp3" type="audio/mpeg">
        </audio>

        <!-- Main Content -->
        <main class="mobile-main-content">
            <div class="mobile-card">
                <div class="text-center mb-lg">
                    <h1 class="page-title">Choose Your Adventure!</h1>
                    <p class="page-subtitle">What would you like to talk about today?</p>
                </div>

                <div class="child-greeting mb-xl">
                    <img src="/static/illustrations/Kiki.png" alt="Kiki" class="kiki-avatar">
                    <div class="greeting-content">
                        <div class="greeting-text">‡§®‡§Æ‡§∏‡•ç‡§§‡•á <span id="childName">...</span>! I am Kiki üëã</div>
                        <div class="greeting-subtext">Let's practice Hindi together through fun conversations!</div>
                        <button id="knowMoreKikiBtn" class="know-more-kiki-btn">Know more about Kiki</button>
                    </div>

                    <!-- Intro controls (hidden by default) -->
                    <button id="introSkipBtn" class="intro-skip-btn">Skip</button>
                    <button id="introTapBtn" class="intro-tap-btn">
                        <span class="tap-emoji">üëÜ</span>
                        <span>Tap to meet Kiki!</span>
                    </button>
                    <div id="introAudioTimer" class="intro-audio-timer">0:00 / 0:00</div>
                </div>

                <!-- Modules Container -->
                <div class="modules-container">
                    {% for module_key in module_order %}
                        {% set module = modules[module_key] %}
                        <div class="module-card" style="--module-color: {{ module.metadata.color }}">
                            <!-- Module Header -->
                            <div class="module-header">
                                <div class="module-header__content">
                                    <h2 class="module-header__title-hindi">{{ module.metadata.name_hindi }}</h2>
                                    <p class="module-header__title-english">{{ module.metadata.name_english }}</p>
                                    <p class="module-header__tagline">{{ module.metadata.tagline }}</p>
                                </div>
                                <div class="module-header__illustration">
                                    <img src="/static/illustrations/{{ module_key }}.png" alt="{{ module.metadata.name_english }}" style="width: 100%; height: 100%; object-fit: contain;">
                                </div>
                            </div>

                            <!-- Topics List -->
                            <div class="topics-list">
                                {% for topic in module.topics %}
                                    <a href="/conversation?type={{ topic.key }}" class="topic-card" data-type="{{ topic.key }}">
                                        <div class="topic-icon">{{ topic.icon }}</div>
                                        <div class="topic-content">
                                            <h3 class="topic-title">{{ topic.name }}</h3>
                                            <p class="topic-description">{{ topic.description }}</p>
                                        </div>
                                        <div class="topic-action">
                                            <button class="topic-btn">Start ‚Üí</button>
                                        </div>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </main>

        <!-- Bottom Navigation will be inserted here by JavaScript -->
    </div>

    <script>
        // Page-specific initialization
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Get user info to display child name
                const response = await fetch('/api/user');
                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }

                const user = await response.json();
                if (!user.child_name) {
                    window.location.href = '/profile-setup';
                    return;
                }

                // Update child name in greeting
                const childNameEl = document.getElementById('childName');
                if (childNameEl) {
                    childNameEl.textContent = user.child_name;
                }

                // Store child name in sessionStorage for process_audio.js
                sessionStorage.setItem('childName', user.child_name);

                // Update page title
                document.title = `Choose Conversation - ${user.child_name}`;

                // Check if user has no conversations yet ‚Üí show intro
                if (!user.has_conversations) {
                    // Small delay to let page fully render
                    setTimeout(() => initFirstTimeIntro(user), 500);
                } else {
                    // Returning user - show "Know more about Kiki" option
                    initKnowMoreButton();
                }

            } catch (error) {
                console.error('Error loading user info:', error);
                window.location.href = '/';
            }
        });

        // First-time user intro flow
        function initFirstTimeIntro(user) {
            const overlay = document.getElementById('introSpotlightOverlay');
            const greeting = document.querySelector('.child-greeting');
            const kikiAvatar = document.querySelector('.kiki-avatar');
            const introAudio = document.getElementById('kikiIntroAudio');
            const tapBtn = document.getElementById('introTapBtn');
            const skipBtn = document.getElementById('introSkipBtn');
            const timerEl = document.getElementById('introAudioTimer');
            const firstTopicCard = document.querySelector('.topic-card');

            if (!overlay || !greeting || !introAudio || !tapBtn) return;

            let timerInterval = null;
            let introCompleted = false;

            // Format seconds as M:SS
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Update timer display
            function updateTimer() {
                if (introAudio.duration && !isNaN(introAudio.duration)) {
                    timerEl.textContent = `${formatTime(introAudio.currentTime)} / ${formatTime(introAudio.duration)}`;
                }
            }

            // End intro and show topic highlight
            function endIntro() {
                if (introCompleted) return;
                introCompleted = true;

                // Stop timer
                if (timerInterval) clearInterval(timerInterval);

                // Stop audio if playing
                introAudio.pause();
                introAudio.currentTime = 0;

                // Hide playback controls
                skipBtn.classList.remove('active');
                timerEl.classList.remove('active');
                kikiAvatar.classList.remove('speaking');

                // Remove spotlight
                greeting.classList.remove('spotlight-active');
                overlay.classList.remove('active');

                // Highlight first topic card with arrow
                if (firstTopicCard) {
                    firstTopicCard.classList.add('intro-highlight');
                    firstTopicCard.style.position = 'relative';

                    // Create and add bouncing arrow
                    const arrow = document.createElement('div');
                    arrow.className = 'intro-topic-arrow';
                    arrow.textContent = 'üëá';
                    arrow.id = 'introTopicArrow';
                    firstTopicCard.appendChild(arrow);

                    // Remove after 5 seconds or on click
                    const cleanup = () => {
                        arrow.remove();
                        firstTopicCard.classList.remove('intro-highlight');
                    };

                    firstTopicCard.addEventListener('click', cleanup, { once: true });
                    setTimeout(cleanup, 5000);
                }
            }

            // Step 1: Show overlay and tap button
            overlay.classList.add('active');
            greeting.classList.add('spotlight-active');
            setTimeout(() => tapBtn.classList.add('active'), 300);

            // Step 2: On tap - play audio
            async function onTapToMeet() {
                tapBtn.classList.remove('active');
                tapBtn.style.display = 'none';

                // Show skip button and timer
                skipBtn.classList.add('active');
                timerEl.classList.add('active');
                kikiAvatar.classList.add('speaking');

                // Start timer updates
                timerInterval = setInterval(updateTimer, 100);

                try {
                    introAudio.volume = 0.8;
                    await introAudio.play();

                    // Wait for audio to end
                    introAudio.onended = endIntro;
                    introAudio.onerror = endIntro;
                } catch (error) {
                    console.error('Intro audio failed:', error);
                    setTimeout(endIntro, 2000);
                }
            }

            // Event listeners
            tapBtn.addEventListener('click', onTapToMeet, { once: true });
            skipBtn.addEventListener('click', endIntro);

            // Also allow clicking overlay to start (before audio plays)
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay && tapBtn.classList.contains('active')) {
                    onTapToMeet();
                }
            }, { once: true });
        }

        // Know more about Kiki - returning users
        function initKnowMoreButton() {
            const knowMoreBtn = document.getElementById('knowMoreKikiBtn');
            const introAudio = document.getElementById('kikiIntroAudio');
            const skipBtn = document.getElementById('introSkipBtn');
            const timerEl = document.getElementById('introAudioTimer');
            const kikiAvatar = document.querySelector('.kiki-avatar');

            if (!knowMoreBtn || !introAudio) return;

            knowMoreBtn.classList.add('active');

            let timerInterval = null;
            let isPlaying = false;

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            function updateTimer() {
                if (introAudio.duration && !isNaN(introAudio.duration)) {
                    timerEl.textContent = `${formatTime(introAudio.currentTime)} / ${formatTime(introAudio.duration)}`;
                }
            }

            function endPlayback() {
                if (!isPlaying) return;
                isPlaying = false;

                if (timerInterval) clearInterval(timerInterval);
                introAudio.pause();
                introAudio.currentTime = 0;

                skipBtn.classList.remove('active');
                timerEl.classList.remove('active');
                kikiAvatar.classList.remove('speaking');
                knowMoreBtn.classList.add('active');
            }

            async function playKikiIntro() {
                if (isPlaying) return;
                isPlaying = true;

                knowMoreBtn.classList.remove('active');
                skipBtn.classList.add('active');
                timerEl.classList.add('active');
                kikiAvatar.classList.add('speaking');

                timerInterval = setInterval(updateTimer, 100);

                try {
                    introAudio.volume = 0.8;
                    await introAudio.play();
                    introAudio.onended = endPlayback;
                    introAudio.onerror = endPlayback;
                } catch (error) {
                    console.error('Audio failed:', error);
                    setTimeout(endPlayback, 2000);
                }
            }

            knowMoreBtn.addEventListener('click', playKikiIntro);
            skipBtn.addEventListener('click', endPlayback);
        }

        // Add click tracking for analytics
        document.addEventListener('click', function(e) {
            const topicCard = e.target.closest('.topic-card');
            if (topicCard) {
                const type = topicCard.getAttribute('data-type');

                // Track the selection (you can add analytics here)
                console.log(`Selected conversation type: ${type}`);

                // Add loading state
                topicCard.style.opacity = '0.8';
                topicCard.style.transform = 'translateY(2px)';

                // Add transition effect
                if (typeof MobilePageUtils !== 'undefined') {
                    MobilePageUtils.showPageTransition();
                }
            }
        });

        // History sidebar functionality
        const historyToggle = document.getElementById('historyToggle');
        const historySidebar = document.getElementById('historySidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebar = document.getElementById('closeSidebar');
        const historyLoading = document.getElementById('historyLoading');
        const historyList = document.getElementById('historyList');
        const historyEmpty = document.getElementById('historyEmpty');

        let conversationHistory = [];
        let historyLoaded = false;

        // Toggle sidebar
        historyToggle.addEventListener('click', function() {
            openHistorySidebar();
        });

        // Close sidebar
        closeSidebar.addEventListener('click', function() {
            closeHistorySidebar();
        });

        // Close sidebar when overlay is clicked
        sidebarOverlay.addEventListener('click', function() {
            closeHistorySidebar();
        });

        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && historySidebar.classList.contains('active')) {
                closeHistorySidebar();
            }
        });

        function openHistorySidebar() {
            historySidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load conversation history if not already loaded
            if (!historyLoaded) {
                loadConversationHistory();
            }
        }

        function closeHistorySidebar() {
            historySidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function loadConversationHistory() {
            try {
                historyLoading.style.display = 'block';
                historyList.style.display = 'none';
                historyEmpty.style.display = 'none';

                const response = await fetch('/api/conversation-history', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Conversation history response status:', response.status);

                // Handle authentication failures
                if (response.status === 302 || response.status === 401) {
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = '/';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Failed to load conversation history: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Conversation history data:', data);

                if (data.success) {
                    conversationHistory = data.conversations;
                    renderConversationHistory();
                    historyLoaded = true;
                } else {
                    throw new Error('API returned error');
                }

            } catch (error) {
                console.error('Error loading conversation history:', error);
                historyLoading.innerHTML = '<p style="color: #dc2626; text-align: center;">Failed to load conversations</p>';
            }
        }

        function renderConversationHistory() {
            historyLoading.style.display = 'none';

            if (conversationHistory.length === 0) {
                historyEmpty.style.display = 'block';
                historyList.style.display = 'none';
                return;
            }

            historyList.style.display = 'block';
            historyEmpty.style.display = 'none';

            // Clear existing items
            historyList.innerHTML = '';

            // Render conversation items
            conversationHistory.forEach(conversation => {
                const historyItem = createHistoryItem(conversation);
                historyList.appendChild(historyItem);
            });
        }

        function createHistoryItem(conversation) {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.setAttribute('data-conversation-id', conversation.id);

            // Format date in user's local timezone
            const date = new Date(conversation.created_at);
            const formattedDate = date.toLocaleDateString(undefined, {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            item.innerHTML = `
                <div class="history-item-header">
                    <span class="history-item-icon">${conversation.type_icon}</span>
                    <span class="history-item-title">${conversation.type_name}</span>
                    <span class="history-item-date">${formattedDate}</span>
                </div>
                <div class="history-item-preview">${conversation.last_message_preview}</div>
                <div class="history-item-stats">
                    <div class="history-stat">
                        <span>üí¨</span>
                        <span>${conversation.sentence_count} sentences</span>
                    </div>
                    <div class="history-stat">
                        <span>‚≠ê</span>
                        <span>${conversation.reward_points} points</span>
                    </div>
                </div>
            `;

            // Add click handler to resume conversation
            item.addEventListener('click', function() {
                resumeConversation(conversation.id);
            });

            return item;
        }

        function resumeConversation(conversationId) {
            // Find the conversation data to get the type
            const conversation = conversationHistory.find(conv => conv.id === conversationId);
            if (!conversation) {
                console.error('Conversation not found:', conversationId);
                return;
            }

            // Add loading state to the item
            const item = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (item) {
                item.style.opacity = '0.6';
                item.style.transform = 'scale(0.98)';
            }

            // Navigate to conversation page with ID and type
            if (typeof MobilePageUtils !== 'undefined') {
                MobilePageUtils.showPageTransition();
            }
            setTimeout(() => {
                window.location.href = `/conversation?id=${conversationId}&type=${conversation.conversation_type}`;
            }, 200);
        }

        // Helper function to refresh history when returning to this page
        window.refreshConversationHistory = function() {
            historyLoaded = false;
            if (historySidebar.classList.contains('active')) {
                loadConversationHistory();
            }
        };
    </script>
</body>
</html>
