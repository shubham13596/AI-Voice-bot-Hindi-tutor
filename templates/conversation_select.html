<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Choose Conversation - Your Hindi Tutor</title>
    
    <link rel="stylesheet" href="/static/css/mobile-design-system.css">
    <script src="/static/js/mobile-navigation.js" defer></script>
    
    <style>
        /* Header layout fixes */
        .mobile-top-bar {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0.5rem 1rem !important;
        }
        
        /* History toggle button */
        .history-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--text-dark);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .history-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .hamburger-icon {
            font-size: 1.2rem;
        }
        
        .history-text {
            font-size: 0.9rem;
        }
        
        /* Sidebar overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* History sidebar */
        .history-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 85vw;
            height: 100vh;
            background: white;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .history-sidebar.active {
            transform: translateX(0);
        }
        
        /* Sidebar header */
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            background: var(--primary-green);
            color: white;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .close-sidebar-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .close-sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Sidebar content */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        /* Loading state */
        .history-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* History list */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        /* History item */
        .history-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: #f3f4f6;
            border-color: var(--primary-green);
            transform: translateY(-1px);
        }
        
        .history-item-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .history-item-icon {
            font-size: 1.2rem;
        }
        
        .history-item-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }
        
        .history-item-date {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: auto;
        }
        
        .history-item-preview {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
        
        .history-item-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .history-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* Empty state */
        .history-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #6b7280;
        }
        
        .history-empty p {
            margin: 0.5rem 0;
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .history-sidebar {
                width: 280px;
            }
            
            .history-text {
                display: none;
            }
            
            .sidebar-content {
                padding: 0.75rem;
            }
            
            .history-item {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Bar with Profile Only -->
        <header class="mobile-top-bar">
            <!-- History button -->
            <button id="historyToggle" class="history-toggle-btn">
                <span class="hamburger-icon">‚ò∞</span>
                <span class="history-text">History</span>
            </button>
            
            <!-- Profile avatar will be inserted here by JavaScript -->
        </header>
        
        <!-- Conversation History Sidebar -->
        <div id="historySidebar" class="history-sidebar">
            <div class="sidebar-header">
                <h3>Recent Conversations</h3>
                <button id="closeSidebar" class="close-sidebar-btn">√ó</button>
            </div>
            <div class="sidebar-content">
                <div id="historyLoading" class="history-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading conversations...</p>
                </div>
                <div id="historyList" class="history-list"></div>
                <div id="historyEmpty" class="history-empty" style="display: none;">
                    <p>No recent conversations found.</p>
                    <p>Start a new conversation to see it here!</p>
                </div>
            </div>
        </div>
        
        <!-- Sidebar overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        
        <!-- Main Content -->
        <main class="mobile-main-content">
            <div class="mobile-card">
                <div class="text-center mb-lg">
                    <h1 class="font-bold text-primary" style="font-size: 2.5rem; margin-bottom: 0.5rem;">Choose Your Adventure!</h1>
                    <p class="text-medium" style="font-size: 1.2rem;">What would you like to talk about today?</p>
                </div>
                
                <div class="child-greeting mb-xl" style="background: #f0fdf4; border-radius: 1rem; padding: 1.5rem; border-left: 4px solid var(--primary-green);">
                    <div class="font-semibold text-primary" style="font-size: 1.3rem;">‡§®‡§Æ‡§∏‡•ç‡§§‡•á <span id="childName">...</span>! üëã</div>
                    <div class="text-medium mt-xs" style="font-size: 1.1rem;">Let's practice Hindi together through fun conversations!</div>
                </div>
                
                <div class="conversation-options-grid">
                    <a href="/conversation?type=everyday" class="conversation-option-card fade-in-up" data-type="everyday">
                        <div class="option-tag">Popular</div>
                        <div class="option-icon">üè†</div>
                        <div class="option-title">Everyday Life</div>
                        <div class="option-description">
                            Talk about your day, school, friends, and daily activities. Perfect for learning practical Hindi!
                        </div>
                    </a>
                    
                    <a href="/conversation?type=cartoons" class="conversation-option-card fade-in-up" data-type="cartoons" style="animation-delay: 0.2s;">
                        <div class="option-tag">Fun</div>
                        <div class="option-icon">üé≠</div>
                        <div class="option-title">Favorite Cartoons</div>
                        <div class="option-description">
                            Chat about your favorite cartoon characters, shows, and stories. Let's make Hindi fun!
                        </div>
                    </a>
                    
                    <a href="/conversation?type=adventure_story" class="conversation-option-card fade-in-up" data-type="adventure_story" style="animation-delay: 0.4s;">
                        <div class="option-tag">Creative</div>
                        <div class="option-icon">üó∫Ô∏è</div>
                        <div class="option-title">Adventure Story</div>
                        <div class="option-description">
                            Create exciting adventure stories together in simple Hindi! Explore new places and meet interesting characters.
                        </div>
                    </a>
                    
                    <a href="/conversation?type=mystery_story" class="conversation-option-card fade-in-up" data-type="mystery_story" style="animation-delay: 0.6s;">
                        <div class="option-tag">Detective</div>
                        <div class="option-icon">üîç</div>
                        <div class="option-title">Mystery Story</div>
                        <div class="option-description">
                            Solve fun mysteries and create detective stories in simple Hindi! Find clues and solve puzzles together.
                        </div>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation will be inserted here by JavaScript -->
    </div>

    <script>
        // Page-specific initialization
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Get user info to display child name
                const response = await fetch('/api/user');
                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }
                
                const user = await response.json();
                if (!user.child_name) {
                    window.location.href = '/profile-setup';
                    return;
                }
                
                // Update child name in greeting
                const childNameEl = document.getElementById('childName');
                if (childNameEl) {
                    childNameEl.textContent = user.child_name;
                }
                
                // Update page title
                document.title = `Choose Conversation - ${user.child_name}`;
                
            } catch (error) {
                console.error('Error loading user info:', error);
                window.location.href = '/';
            }
        });

        // Add click tracking for analytics
        document.addEventListener('click', function(e) {
            const conversationCard = e.target.closest('.conversation-option-card');
            if (conversationCard) {
                const type = conversationCard.getAttribute('data-type');
                
                // Track the selection (you can add analytics here)
                console.log(`Selected conversation type: ${type}`);
                
                // Add loading state
                conversationCard.style.opacity = '0.8';
                conversationCard.style.transform = 'translateY(2px)';
                
                // Add transition effect
                MobilePageUtils.showPageTransition();
            }
        });
        
        // History sidebar functionality
        const historyToggle = document.getElementById('historyToggle');
        const historySidebar = document.getElementById('historySidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebar = document.getElementById('closeSidebar');
        const historyLoading = document.getElementById('historyLoading');
        const historyList = document.getElementById('historyList');
        const historyEmpty = document.getElementById('historyEmpty');
        
        let conversationHistory = [];
        let historyLoaded = false;
        
        // Toggle sidebar
        historyToggle.addEventListener('click', function() {
            openHistorySidebar();
        });
        
        // Close sidebar
        closeSidebar.addEventListener('click', function() {
            closeHistorySidebar();
        });
        
        // Close sidebar when overlay is clicked
        sidebarOverlay.addEventListener('click', function() {
            closeHistorySidebar();
        });
        
        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && historySidebar.classList.contains('active')) {
                closeHistorySidebar();
            }
        });
        
        function openHistorySidebar() {
            historySidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Load conversation history if not already loaded
            if (!historyLoaded) {
                loadConversationHistory();
            }
        }
        
        function closeHistorySidebar() {
            historySidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        async function loadConversationHistory() {
            try {
                historyLoading.style.display = 'block';
                historyList.style.display = 'none';
                historyEmpty.style.display = 'none';
                
                const response = await fetch('/api/conversation-history');
                if (!response.ok) {
                    throw new Error('Failed to load conversation history');
                }
                
                const data = await response.json();
                if (data.success) {
                    conversationHistory = data.conversations;
                    renderConversationHistory();
                    historyLoaded = true;
                } else {
                    throw new Error('API returned error');
                }
                
            } catch (error) {
                console.error('Error loading conversation history:', error);
                historyLoading.innerHTML = '<p style="color: #dc2626; text-align: center;">Failed to load conversations</p>';
            }
        }
        
        function renderConversationHistory() {
            historyLoading.style.display = 'none';
            
            if (conversationHistory.length === 0) {
                historyEmpty.style.display = 'block';
                historyList.style.display = 'none';
                return;
            }
            
            historyList.style.display = 'block';
            historyEmpty.style.display = 'none';
            
            // Clear existing items
            historyList.innerHTML = '';
            
            // Render conversation items
            conversationHistory.forEach(conversation => {
                const historyItem = createHistoryItem(conversation);
                historyList.appendChild(historyItem);
            });
        }
        
        function createHistoryItem(conversation) {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.setAttribute('data-conversation-id', conversation.id);
            
            // Format date
            const date = new Date(conversation.created_at);
            const formattedDate = date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            item.innerHTML = `
                <div class="history-item-header">
                    <span class="history-item-icon">${conversation.type_icon}</span>
                    <span class="history-item-title">${conversation.type_name}</span>
                    <span class="history-item-date">${formattedDate}</span>
                </div>
                <div class="history-item-preview">${conversation.last_message_preview}</div>
                <div class="history-item-stats">
                    <div class="history-stat">
                        <span>üí¨</span>
                        <span>${conversation.sentence_count} sentences</span>
                    </div>
                    <div class="history-stat">
                        <span>‚≠ê</span>
                        <span>${conversation.reward_points} points</span>
                    </div>
                </div>
            `;
            
            // Add click handler to resume conversation
            item.addEventListener('click', function() {
                resumeConversation(conversation.id);
            });
            
            return item;
        }
        
        function resumeConversation(conversationId) {
            // Add loading state to the item
            const item = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (item) {
                item.style.opacity = '0.6';
                item.style.transform = 'scale(0.98)';
            }
            
            // Navigate to conversation page with ID
            MobilePageUtils.showPageTransition();
            setTimeout(() => {
                window.location.href = `/conversation?id=${conversationId}`;
            }, 200);
        }
        
        // Helper function to refresh history when returning to this page
        window.refreshConversationHistory = function() {
            historyLoaded = false;
            if (historySidebar.classList.contains('active')) {
                loadConversationHistory();
            }
        };
    </script>
</body>
</html>